{% extends 'base.html' %}

{% block title %}Dashboard - Secullum Hub{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0 font-weight-bold">Dashboard de Monitoramento</h1>
    <div class="text-muted small">Última sincronização: {{ last_sync|default('Nunca', true) }}</div>
</div>

<div class="row g-4 mb-4">
    <div class="col">
        <div class="card h-100 p-3 stats-card">
            <div class="icon-box bg-blue-soft">
                <i class="fas fa-users fa-lg"></i>
            </div>
            <div class="text-muted small fw-bold text-uppercase">Funcionários</div>
            <div class="h2 mb-0 font-weight-bold">{{ total_funcionarios|default(0) }}</div>
            <div class="small text-green mt-2"><i class="fas fa-check-circle me-1"></i> Sincronizados</div>
        </div>
    </div>
    <div class="col">
        <div class="card h-100 p-3 stats-card">
            <div class="icon-box bg-green-soft">
                <i class="fas fa-fingerprint fa-lg"></i>
            </div>
            <div class="text-muted small fw-bold text-uppercase">Batidas Hoje</div>
            <div class="h2 mb-0 font-weight-bold">{{ batidas_hoje|default(0) }}</div>
            <div class="small text-muted mt-2">Atualizado em tempo real</div>
        </div>
    </div>
    <div class="col">
        <div class="card h-100 p-3 stats-card">
            <div class="icon-box bg-purple-soft">
                <i class="fas fa-clock fa-lg"></i>
            </div>
            <div class="text-muted small fw-bold text-uppercase">Atrasos/Inconsist.</div>
            <div class="h2 mb-0 font-weight-bold">{{ inconsistencias|default(0) }}</div>
            <div class="small text-danger mt-2"><i class="fas fa-exclamation-triangle me-1"></i> Requer atenção</div>
        </div>
    </div>
    <div class="col">
        <div class="card h-100 p-3 stats-card">
            <div class="icon-box bg-orange-soft">
                <i class="fas fa-user-clock fa-lg"></i>
            </div>
            <div class="text-muted small fw-bold text-uppercase">Em Jornada</div>
            <div class="h2 mb-0 font-weight-bold">{{ em_jornada|default(0) }}</div>
            <div class="small text-muted mt-2">Ativos no momento</div>
        </div>
    </div>
    <div class="col">
        <a href="{{ url_for('escalas.divergencias') }}" class="text-decoration-none">
            <div class="card h-100 p-3 stats-card" style="border-color: {{ 'rgba(239,68,68,0.4)' if ausencias else 'rgba(255,255,255,0.1)' }};">
                <div class="icon-box" style="background-color: rgba(239,68,68,0.1); color: #ef4444;">
                    <i class="fas fa-user-xmark fa-lg"></i>
                </div>
                <div class="text-muted small fw-bold text-uppercase">Ausências Hoje</div>
                <div class="h2 mb-0 font-weight-bold {{ 'text-danger' if ausencias else '' }}">{{ ausencias|length }}</div>
                <div class="small mt-2 {{ 'text-danger' if ausencias else 'text-muted' }}">
                    {% if ausencias %}<i class="fas fa-exclamation-triangle me-1"></i> Ver divergências{% else %}<i class="fas fa-check-circle me-1"></i> Sem ausências{% endif %}
                </div>
            </div>
        </a>
    </div>
</div>

{% if ausencias %}
<div class="alert alert-warning d-flex align-items-center mb-4" role="alert">
    <i class="fas fa-exclamation-triangle me-3 fa-lg"></i>
    <div>
        <strong>{{ ausencias|length }} ausência(s) hoje</strong> — escalados sem batida:
        <span class="ms-1">{{ ausencias|map(attribute='nome')|join(', ') }}</span>
    </div>
    <a href="{{ url_for('escalas.divergencias') }}" class="btn btn-sm btn-warning ms-auto">Ver divergências</a>
</div>
{% endif %}

<div class="row g-4">
    <!-- Atividade recente (feed compacto) -->
    <div class="col-lg-8">
        <div class="card">
            <div class="d-flex justify-content-between align-items-center px-4 pt-4 pb-2">
                <h6 class="mb-0 fw-semibold">Atividade de Hoje</h6>
                <a href="/espelho" class="btn btn-sm btn-outline-light">Ver espelho completo</a>
            </div>
            <div class="px-4 pb-4">
                {% if batidas %}
                <div class="d-flex flex-column gap-1 mt-2">
                    {% for batida in batidas %}
                    <div class="d-flex align-items-center py-2" style="border-bottom: 1px solid #f1f5f9;">
                        <div class="flex-shrink-0 me-3">
                            <span class="badge rounded-pill px-2
                                {% if batida.inconsistente %}bg-danger
                                {% elif batida.tipo == 'Entrada' %}bg-success
                                {% else %}bg-secondary{% endif %}"
                                style="font-size:0.7rem; min-width:52px; text-align:center;">
                                {{ batida.hora or '—' }}
                            </span>
                        </div>
                        <div class="flex-grow-1 small fw-semibold text-truncate" style="max-width:220px;">
                            {{ batida.funcionario.nome if batida.funcionario else '—' }}
                        </div>
                        <div class="flex-shrink-0 ms-auto d-flex align-items-center gap-2">
                            <span class="text-muted small">{{ batida.tipo or '—' }}</span>
                            {% if batida.inconsistente %}
                            <span class="badge bg-danger-subtle text-danger" style="font-size:0.68rem;">Incompleto</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center text-muted py-5">
                    <i class="fas fa-clock fa-2x mb-3 d-block opacity-25"></i>
                    Nenhuma batida registrada hoje.
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Painel lateral -->
    <div class="col-lg-4 d-flex flex-column gap-4">
        <!-- Ações rápidas -->
        <div class="card p-4">
            <h6 class="fw-semibold mb-3">Ações Rápidas</h6>
            <button class="btn btn-primary w-100 mb-2" data-bs-toggle="modal" data-bs-target="#syncModal">
                <i class="fas fa-sync me-2"></i>Sincronizar Tudo
            </button>
            <a class="btn btn-outline-light w-100 mb-2" href="/relatorios">
                <i class="fas fa-file-pdf me-2"></i>Relatório do Dia
            </a>
            <a class="btn btn-outline-light w-100" href="/escalas/">
                <i class="fas fa-calendar-week me-2"></i>Gerenciar Escalas
            </a>
        </div>

        <!-- Resumo do dia -->
        <div class="card p-4">
            <h6 class="fw-semibold mb-3">Resumo do Dia</h6>
            <div class="d-flex flex-column gap-2">
                <div class="d-flex justify-content-between align-items-center small">
                    <span class="text-muted"><i class="fas fa-fingerprint me-2 text-primary opacity-75"></i>Batidas registradas</span>
                    <span class="fw-bold">{{ batidas_hoje }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center small">
                    <span class="text-muted"><i class="fas fa-user-clock me-2 text-success opacity-75"></i>Em jornada agora</span>
                    <span class="fw-bold text-success">{{ em_jornada }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center small">
                    <span class="text-muted"><i class="fas fa-exclamation-triangle me-2 text-warning opacity-75"></i>Inconsistências</span>
                    <span class="fw-bold {{ 'text-danger' if inconsistencias else '' }}">{{ inconsistencias }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center small">
                    <span class="text-muted"><i class="fas fa-user-xmark me-2 text-danger opacity-75"></i>Ausências</span>
                    <span class="fw-bold {{ 'text-danger' if ausencias else '' }}">{{ ausencias|length }}</span>
                </div>
                <hr class="my-1" style="border-color: var(--border-color);">
                <div class="d-flex justify-content-between align-items-center small text-muted">
                    <span><i class="fas fa-clock-rotate-left me-2"></i>Última sync</span>
                    <span>{{ last_sync }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sync Modal -->
<div class="modal fade" id="syncModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-secondary text-white border-0">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="syncModalLabel">Sincronização em andamento</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"
                    id="syncCloseBtn"></button>
            </div>
            <div class="modal-body text-center py-4">
                <div id="syncLoading">
                    <div class="spinner-border text-info mb-3" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mb-0">Buscando dados da API Secullum. Isso pode levar alguns segundos.</p>
                    <small class="text-muted">Aguardando resposta do servidor...</small>
                </div>
                <div id="syncResult" style="display: none;">
                    <div class="mb-3">
                        <i id="syncIcon" class="fas fa-check-circle fa-3x text-success"></i>
                    </div>
                    <h5 id="syncTitle">Sucesso!</h5>
                    <p id="syncMessage"></p>
                    <button class="btn btn-primary mt-3" onclick="window.location.reload()">Atualizar Dashboard</button>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    document.getElementById('syncModal').addEventListener('shown.bs.modal', function () {
        const loadingDiv = document.getElementById('syncLoading');
        const resultDiv = document.getElementById('syncResult');
        const icon = document.getElementById('syncIcon');
        const title = document.getElementById('syncTitle');
        const message = document.getElementById('syncMessage');
        const modalTitle = document.getElementById('syncModalLabel');

        // Reset status
        loadingDiv.style.display = 'block';
        resultDiv.style.display = 'none';
        modalTitle.innerText = 'Sincronização em andamento';

        fetch('/api/sync')
            .then(response => response.json())
            .then(data => {
                loadingDiv.style.display = 'none';
                resultDiv.style.display = 'block';
                modalTitle.innerText = 'Sincronização finalizada';

                if (data.success) {
                    icon.className = 'fas fa-check-circle fa-3x text-success';
                    title.innerText = 'Sincronização concluída';
                } else {
                    icon.className = 'fas fa-exclamation-circle fa-3x text-danger';
                    title.innerText = 'Falha na sincronização';
                }
                message.innerText = data.message;
            })
            .catch(error => {
                loadingDiv.style.display = 'none';
                resultDiv.style.display = 'block';
                modalTitle.innerText = 'Erro crítico';
                icon.className = 'fas fa-bug fa-3x text-warning';
                title.innerText = 'Erro na requisição';
                message.innerText = 'Não foi possível conectar ao servidor: ' + error;
            });
    });
</script>
{% endblock %}
{% endblock %}